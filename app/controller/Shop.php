<?php

namespace app\controller;

use support\Request;
use app\model\Shop as ShopModel;

class Shop extends Base
{
    public $iv = 'AED7966C958C149632180F51EDBC9313';
    public $weixiao_private = '30820278020100300D06092A864886F70D0101010500048202623082025E02010002818100DDC2754B64A6B16A41601BEB7F40699922F2A22CB73741C0589475FA984BC08E6075DEB733F1EDC71DD15AEC28898EF32E13BB6BD6AEFE9F5F78D556C258F09C58EB932005449263A97F11569156A41DE0178E6A2F80F9CF4D82B7C0749B4658D27EB63F304F9186DEDA0F08C724424A19908C800019921FFE793B813AD39AAD02030100010281803837A1D09915810874C64E8DA6D6C76E60E3ADA5345537BFF134C1ABE38BE0A6B7616A327B62AB6ABCEE63E4566A78E8C117937DC510DBCFBF3E3CA71FE1B82D11B0EC968E6E7A233BC6FDD49768C5694696404C0268BAF5A1D5F833876D47AE87C052F9895AF448A755CC66E20972B9C8E1DB4A6C93BD88C88AC29CD2C6A2A9024100F343FDC66BF142A32114453DE897F65D930E6CC6ECF9DED8B286CC4C196FC4D90626810D08B5F1DB0FEC1EB37E00238EF4ACB3F2015174B44CAAF35C69C7263F024100E95E43B9064F83210DE2406071CEA9090F8FF19EC7CD319BC63A1BD09145D66F51D51192BB35320767489B8B456053513B158557E9AB546BF09E5FB1D8AB3C13024100A741E4467D09108C20BE532D51B2CA0D6482D27FA387D9949C8ADA04A8A8946BB332DE201C111D0D45514F7A91F37E7F57F33675FA3A0B47BC3EFDBC586E38F9024100DBE966AC2F14329FAD73ADF2B48C68A20F36381CC66FC8F5E060D5E13F64AE640C9B5A8A093C61BEB447A9BC1E4E5D7548D648E7C55D1C9AF30E6B632EA87E5D024100D5F9A5CB89621A68B5DF4D262D99907914AD7DAF31C72FBC822A998DEEE63A5A6A14C67A7A2E70BCCBEAE7E077479B4FD264B769E90F69C41B01A54710030D23';


    /**
     * 列表
     */
    public function index(Request $request)
    {
        $file = 'public/dz202211250001600034430.txt';
        var_dump(file_exists($file));
        if (file_exists($file)) {
            $fp = fopen($file, 'r');
            $str = fread($fp, filesize($file));
            // $str = '{"cipherText":"1F9D723377CF88AF2DA16BB3C0741198A0C6CBFE02AC3D564E55B2F70D9333C824C6EF09B60A98C77F70235356FB434E6954DBCAF1F80E46FC823EEE5CF2A8AA0D82AFD41B899D977981A7AE3AE3C4EBF002236220EF1F7757630B8E92494AB46584A590C0FB250F87888F5BF2E20E42787EC1EA790D0470087641BC7A695F68BBAD96EB6D5DF7027BD076AC7AA5B8C6E9C55E73488AC3C0933A82479C2BEA355080B329F6C67655E5D94B8FB26060F75A67732001DAB095EC5BD64D75B82C1C3C331672F62BD5BB9064F2C3ADE521013C84F85BB27252938A43DFCDB7881C128FB621BC4D91F5A7C4F3C0C085773062558CE226012CAB15F58287B29492BA2DB6B92329AE12AD4485B304ACD49F7F08976A7CD58927FA952635D025CD2EF48EECD0D2FE7C4B1466C487B586D32A975F4AA970700A4E52E0249D238ED398C7BFF37082218B317C04B1AB4958746FB3BB0895B4943C48B694635160D9F1D88AF84A9EE935F8F48EEE77D5E9B2E7D4BB0AE3310996B76223E28F01516998E76179768F5F5417667C716AD769A3C6F8DBD409733824B61ABD349BF95201D06E172A3A47CAB8AEC9BB83639DD41B749C1ACB7B5F3C0062C9CB9751F9E9DCA9D9F3A379D58DBA04C1CBF82F8ED55B09F866094D2F14A23C79E6B2B74A8CB7A9CA8D21E2E108AD0101DA95F4972CA13AEDB3DB31496E103A24107088421C820591E40DA8C3FD18BD86867B2559C169597D0E621ADFC30D17BA3AB52E69D3B50A658988A0B4B93703858AFEA1F2D7422F981EB01898AA4D26267A362B36D81A824210DEA359308322A3416C68A2E86C8AA5738B5577212399F23F74E7535E29A319669790F38C9F717E2B9CD0B3417E7F9217DA4CF61E3285CE0EA544C55FE39A47265E8E7663DD770EA67C9BD0CCB5B84465CFBFB97FA3B5308BFD4A68A2E2A130F4618B6EA02D053F77CC809FCFD828EBCFC0CA25BA9AC235A6CFCF7EC98E92CC99A9","skey":"83836C10A6D1AC122FBF2B98B3154C20BBA80C6AD2CC781253323E1C34605AFB1216AF17F329FAE3ADF2C4A6F50397B317A99FF4B24D8DC802586AFFD4AC6F0B6988F473A626122E75BEB7C95D9B21D8BD78C584F530F695E156AEBA743DFC0D11FC47D54A69E507C5317F9D1E58DBABF6A4B9702A19B4E7BF9FB198A7AC2017"}';
           
            $str = '{"cipherText":"11F57D3DEE8099352E4440A8B140D0EFD0E7691AF016047FC743166C7783EF3DCAAC0E4A56E3769F2A400A1F1C126A9073460799111397FE3B6224AF9FD4BDA3945066EF95A8E9976330DE437DD1DF5BD30AF64B7A58F0BE228432C10B58EA1C44B3F06840D2E1CAD257BE1DF6D4645D542FA0246E2388F59FC900B907F90AA5C6986AA78317E51B2A0D3548F34CBBCF1EDF398E437848A3E260E29A2041DAB4767E9C062C467C454955B4B107BD8AB4CDEE69BAD3D254DA0BF2763070BF2D9AB49C05380BD5B8CB6D9AEC711FDB96E7FB9E4906D7C3C8F5BEC919B8CAD4CEB70E741FEE15B8094190056053B4C2DA9B758551EAB6D7682E5AE8CC7CD2BC5F46C50644F50CCF28438369D6847F8E357B2A06FB0D2BD719C6DF56ABAAE7A6F6C86FADD5BAA15B16524A45308E6B372B1F4FE3620E197580713B6F98B72947DB653D0C189BFAAC68BE2262FE0886875ECBE4FDC1F6C8632C10FC8C56C481EFBA2B86C7093B07FA5805CCE11CABFFC234499CC80EE8B0195D620618BB1454294CB6E98C13AC40633B71B81AE8588BB1D999B788E0EC552F4E47D317B4C6ED386CABF9B5236EEC88447315FF3EE5FE188192A6412DADD12DD31D003C2218E2C57A608A890F2FA3C74784946B6BDF7253863974BD7750AE0A4DF698C50F47E31527B76D79E1EAC7E5A432BC5CE2D85D04FA654E49CEA245631E932BCF6B9E56F1988C9530A942D4511B62264CA79BFD61FC76CC22F62CE025B211A602B9039F497A81EBE314AC4CB8F2C0AB408A21E7FAA4E6","skey":"1D968C98A85E8D8F48E1D454B0D783608E0E9691169A97D476BB8B99D47473FADAC5BACEE76275C28D09EA93E5478018677BA01E48D8BBC08CD9C4A705390FB54DE28D19D022890D79E34B58CB945EB0813AE63F36921FE1D7BBD066C2735084E999FB3BBF5E587A23C049FB4FAFA677B06BC2859C4E571B805363B267AB46E5C3E75316EB3E7A4A2428E6424DF8BED0D034AA2DE1848DC593EE365378AD7DCA847D1F47E964AA24D2C68C333A252DE8C8F53B390C3EA5EB90253CB874C562CC61D0B678A3F4202C712EA17B50AC8DC54AB38F70C8C637DBBEE39021615E841320CBDCF2B0D017EA1B6F98D10453C90608EB413D75668EF259E0F2EA355A6D8C"}';
           
            $str = json_decode($str, true);
            
            $result = $this->deRsaSign($str['cipherText'], $str['skey']);
            // $result = '{"plainText":"20221125 \n | 82 | 31635.02 |"}';
            // $result = iconv('UTF-8', 'UTF-8', $result);
            var_dump($result);
            $result = str_replace("\n", "\\n", $result);
            // $result = htmlspecialchars_decode($result);
            // str_replace(array(" ", "\r", "\n", "\t"), "", $result);
            // $result = str_replace('"', '-', $result);
            $result = json_decode($result, true);
            
            // var_dump(json_last_error());
            $result = explode("\n", $result['plainText']);
            $result = array_filter($result);
            $data = [];
            // foreach ($result as $key => &$val) {
            //     if (substr_count($val, '|') != 13) {
            //         unset($result[$key]);
            //         continue;
            //     }
            //     // $val .= substr_count($val, '|');
            //     $row = explode('|', $val);
            //     $data[] = [
            //         $row[0], $row[1]
            //     ];
            // }
            
            return $this->success($result);
        }
    }

    public function test($content)
    {
        
        $bank_key = '30820122300D06092A864886F70D01010105000382010F003082010A0282010100AE4925DA938E15AE296DA3F02380E83DEAF6D86448FDC062E7FE8F17057792B18FF138632936845711D6893A5E9D026B5E75A4BD716E0528711D8375982EDDBD0DCD14C2A8D0AB14BD20EE9D14A17E0C0564B2F8C9BC25C64DDE62A307E7346DE3CCF634FE4B2C2FCDAA959848B1853F255979AB553C237EDEB66AD06668885367CED2893DDA19C67C3CFAAE68DDE7E149C9ABC75E133AE5BDE072DE506117D6DD13D69A3FD0BEC972F7C41E9F34DEB122FF9FC3F4B777BA6CC66CD5FC0CB35DD5866D3DF1D8B95966BB756212B6423F950C10DF3418FD1AE1A5E74515C36CA12CBF974B044B340A7F37CE8886BAACBC0B137F383645D04E65832BA0077D88050203010001';
        $bank_key = base64_encode(hex2bin($bank_key));
        // $iv = 'AED7966C958C149632180F51EDBC9313';        

        return $this->success($this->iv);
    }

    public function deRsaSign($cipherText, $skey)
    {
        // 解密 skey 得到对称密钥
        $de_skey = $this->decryptRsa($skey, $this->weixiao_private);

        // 使用对称密钥解密cipherText
        $de_cipherText = $this->decryptAes($cipherText, $de_skey, $this->iv);
        return $de_cipherText;
        // 获取
        $plain_text = json_decode($de_cipherText, true);
        var_dump($de_cipherText);
        if (!isset($plain_text['plainText']) || !isset($plain_text['sign'])) {
            return false;
        }
        // 服务方使用请求方公钥验证签名
        // $result = $this->verifySign($plain_text['plainText'], $plain_text['sign'], $this->bank_public);
        
        // if (!$result) {
        //     return false;
        // }
        return $plain_text['plainText'];
    }

    /**
     * 非对称解密
     * @param string $data 加密内容
     * @param string $key 服务方私钥解密
     */
    public function decryptRsa($data, $key)
    {
        $data = hex2bin($data);
        $key = base64_encode(hex2bin($key));
        $key = chunk_split($key, 64, "\n");
        $key = "-----BEGIN RSA PRIVATE KEY-----\n$key-----END RSA PRIVATE KEY-----\n";
        var_dump($key);
        $key = '-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCkAQOUGkXtoPg8
p9qQuRbw6JxIUAmTtHZEGXAicBNR23lzHK7VMDi3x1MIiyYISRRgQE92pn/XmGhr
zz19NnR2xiO5/Kx0tPRwSyfBoosf/n2evAQ8a6lEDNIR2/90HjdfPAn8Y7K0p1OI
s+xQp1bNcafe7hnsneQ+USeKKaj/RWn/zLoKI1kWFhoK6SEa2sGtQ/FezxICUbCD
bO76k1ZqjXEpOgkzsR4HE+90mD+m7jFCco1mgZ8/Ayo5eULu7xjQKCTTILx9tqUr
qKlQFSqgCgqv4VywdbxoLqIv34KB414EWpvXkblcDynZ6K/uW13Dtgo5jJs8JuUF
UP+UvoGHAgMBAAECggEADMHvb1Pj4KpG5SEBhYSAXlkZ3x4qwIynLoD0Ehm5xwJV
nji6+OZ5YwJkWSPJ35cfuKUICWjGRRUb+lbyp4zW3m5nVQ5ss99nrFyMSSnFvMVl
LDXf9ntBfYOpy63bX0MCd6wJ8tImkpr5iobEeTmrLOwMbPEEnz1hBd/2PW8kMEcs
G0dCAJWDX5DRyDdhzh0rEnylJP/V549/NKI+3TjUu3sJq4AFCDh9Oo0uucLT6rBZ
qlmimJ5SVsQiZyB6752glazRIZ23H9ZiggjrUc2qEPWP8sRn4ZVxOdlEUKL2pS/f
zwFYaCqiltEFJvwUsMpTodpIbYTwMxGUgx3dwbeMIQKBgQDZDW0SK8uLD0x1l1+6
1oRPhuOCUMRpOLKJsAgQSXCLlqMc4J7ClDz3Qhh/kNsn0y0tYK0hgUL+seGE8clk
HeA0K2dxABzGqHhBbV1WfnxNWGt8ZjQVXVAyDUU8mrcf5dnVbiQcXlGiMq7lWOuC
DnG7CJuz2EngzfoxMGv/XHX3mQKBgQDBbr1k/TMmQGz6EUGXAGWm5M8gvHEnkAEI
sJJj/cfNuYNt95Lpz+LBFJqOkwOcuOzizgVzA22udOdWLVRfxBMAMmQqHGNu+dNP
7++pdHKbQ9JVOeQunoEX5hXHghyrt1Qaq6W0hqfmFAD1qjRVGYJe7joPSMmFgKpD
UDSZZh12HwKBgA3M+71nCXcbDup/KHgRwbHoyrhzeDmUgE2e4rReZwiJGG/ynEWU
9VdnXXVm+XhLxhiXiAqUVHUrTEKOuRZji+jlRZt6vVmoRpUqZf/k5PRqBdOQEAm3
uCymiVt0HuapT7NxYFxpZtlgTZyJjdfkITkaMAQ8YV4o2pqcEJHZCCspAoGBAIqD
lFhHAGO56s+/n6pT/Hbgjnowtw7Pjg388zdrObLVz4nlqWyJEyWUbYD/Qazut6NK
SJitsdMln6sUVsElFT4k15lYLtP/ThSGCqbb3l3U2T9ybzX7BxJoDtyJDaLhavaW
R9jYPE8DsBQ7R7JQzAzSpvze8IALPOFrA999QkedAoGAUQ4IcDY6ToJxaiMclpVA
eM4iCJ6oe1GxQGT6evyENCnuSuSiYcoV2Ys02pIAPrFGI4mlEHA3YquSPrxFigyW
vlwxuGeGCMbctJquaqTXIHH+Az9XeFMLq2uyovKkT/UAy4EDW7/wKuFPqlY+sIEr
uyR4ue9K5cI7LTpvKkv73p0=
-----END PRIVATE KEY-----';
        openssl_private_decrypt($data, $decrypted, $key);
       
        $decrypted = iconv('GB2312', 'UTF-8', $decrypted);
        
        return $decrypted;
    }

    /**
     * 对称解密
     * @param string $data 加密内容
     * @param string $key 密钥 $key = '9B6C238C991BCA09543CB926C43B3DE4';
     * @param string $iv 向量 $iv = 'AED7966C958C149632180F51EDBC9313';
     */
    public function decryptAes($data, $key, $iv)
    {
        $data = hex2bin($data);
        $key = hex2bin($key);
        $iv = hex2bin($iv);
      
        $result = openssl_decrypt($data, 'AES-128-CBC', $key, OPENSSL_RAW_DATA, $iv);
        $result = iconv('GB2312', 'UTF-8', $result);

        return $result;
    }

    /**
     * 验证签名
     * @param string $data 签名内容
     * @param string $sign 签名
     * @param string $pub_key 请求方公钥
     */
    public function verifySign($data, $sign, $pub_key)
    {
        $data = iconv('UTF-8', 'GB2312', $data);
        $sign = hex2bin($sign);
        $pub_key = base64_encode(hex2bin($pub_key));
        $pub_key = chunk_split($pub_key, 64, "\n");
        $pub_key = "-----BEGIN PUBLIC KEY-----\n$pub_key-----END PUBLIC KEY-----\n";
        $result = openssl_verify($data, $sign, $pub_key) === 1;

        return $result;
    }

}
